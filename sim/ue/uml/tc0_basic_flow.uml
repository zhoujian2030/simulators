@startuml
autonumber
title TC0 basic flow

participant "Mock UE" as ue
participant "Mock PHY" as phy
participant "L2" as l2
participant "L3" as l3

note over ue, l2
UE sends MSG1
end note

ue -> l2 : [**0.1**] RACH, RA-RNTI, preamble

note over ue, l2
Network sends MSG2 with 2 TTI advance to PHY
end note

l2 -> phy : [**0.3**] FAPI_DL_DCI_FORMAT_1A, RA-RNTI
l2 -> phy : [**0.3**] FAPI_DLSCH_PDU , RA-RNTI
l2 -> ue : [**0.5**] RAR, TC-RNTI

note over ue, l2
UE sends MSG in the 2nd UL SF after RAR received
end note
l2 -> phy : [**1.1**] FAPI_ULSCH (1 TTI advance)
ue -> l2 : [**1.2**] MSG3 (RRC Connection Request), TC-RNTI
phy -> l2 : [**1.2**] MSG3 CRC (0: Correct)

note over ue, l2
Network sends MSG4
end note
l2 -> phy : [**1.6**] FAPI_DL_DCI_FORMAT_1A, TC-RNTI
l2 -> phy : [**1.6**] FAPI_DLSCH_PDU , TC-RNTI
l2 -> ue : [**1.8**] Contention Resolution, TC-RNTI
l2 --> phy : [**2.1**] UCI_HARQ (Cfg PHY to recv HARQ)
ue -> l2 : [**2.2**] HARQ ACK

note over ue, l2
Network sends RRC Setup.
Which SFN/SF to send RRC setup in MAC depends on the time 
receiving RRC setup from RRC
end note

l2 -> l3 : RRC Connection Request 
l3 -> l2 : Create UE context (PDCP/RLC/MAC/PHY)
l2 -> phy : Config UE
l2 -> l3 : Response
l3 -> l2 : RRC Connection Setup

l2 -> phy : [**2.6**] FAPI_DL_DCI_FORMAT_1A, C-RNTI = TC-RNTI
l2 -> phy : [**2.6**] FAPI_DLSCH_PDU, C-RNTI
l2 -> ue : [**2.8**] RRC Connection Setup, C-RNTI
l2 --> phy : [**3.1**] UCI_HARQ (Cfg PHY to recv HARQ)
ue -> l2 : [**3.2**] HARQ ACK (for RRC Connection Setup)

note over ue, l2
UE sends SR in the next UL SF after HARQ ACK for RRC Setup sent
Network send DCI0 to UE to allocate 1 RB for BSR, UE sends BSR 
4 SF's after DCI0 received
end note

l2 --> phy : [**3.6**] UCI_SR (Cfg PHY to recv SR)
ue -> l2 : [**3.7**] SR
l2 -> ue : [**4.3**] FAPI_UL_DCI_FORMAT_0 (1 RB)
l2 -> phy : [**4.6**] FAPI_ULSCH
ue -> l2 : [**4.7**] BSR
phy -> l2 : [**4.7**] BSR CRC (0: Correct)

l2 -> phy : [**4.8**] FAPI_DL_DCI_FORMAT_1
l2 -> phy : [**4.8**] FAPI_DLSCH_PDU
l2 -> ue : [**5.0**] MAC Timing Advance Command

note over ue, l2
Network schedules UL resource for RRC Setup complete according
to BSR value received, also HARQ ACK for BSR is sent together
end note

l2 -> ue : [**5.3**] FAPI_HI_PDU (HARQ ACK for BSR)
l2 -> ue : [**5.3**] FAPI_UL_DCI_FORMAT_0 (8 RB)
l2 -> phy : [**5.6**] FAPI_ULSCH_HARQ (For receiving RRC setup complete and HARQ ACK)
ue -> l2 : [**5.7**] RRC Setup Complete
phy -> l2 : [**5.7**] RRC Setup Complete CRC (0: Correct)
ue -> l2 : [**5.7**] HARQ ACK (for TA Command)

l2 -> l3 : RRC Setup Complete

note over ue, l2
Network send force UL grant to allocate UL resource 
end note

l2 --> ue : [**5.8**] FAPI_UL_DCI_FORMAT_0 (10 RB)

note over ue, l2
MAC schedules Identity Request when receives msg from RRC 
end note

l3 -> l2 : Identity Request

l2 -> phy : [**5.9**] FAPI_DL_DCI_FORMAT_1A
l2 -> phy : [**5.9**] FAPI_DLSCH_PDU
l2 -> ue : [**6.1**] Identity Request (RLC seg 1)
l2 -> phy : [**6.1**] FAPI_DL_DCI_FORMAT_1A
l2 -> phy : [**6.1**] FAPI_DLSCH_PDU
l2 --> phy : [**6.1**] FAPI_ULSCH (for UL DCCH data)
ue --> l2 : [**6.2**] Zero Long BSR 
phy --> l2 : [**6.2**] Zero Long BSR CRC (0: Correct)
l2 -> ue : [**6.3**] Identity Request (RLC seg 2, need RLC ACK)

note over ue, l2
Network continues to send force UL grant to allocate UL resource 
end note
l2 -> ue : [**6.3**] FAPI_HI_PDU (HARQ ACK for RRC setup complete)
l2 --> ue : [**6.3**] FAPI_UL_DCI_FORMAT_0 (16 RB)
l2 --> phy : [**6.6**] FAPI_ULSCH_HARQ (for UL DCCH data and HARQ ACK)
ue -> l2 : [**6.7**] HARQ ACK (for Identity Request seg 1 & seg 2)
ue -> l2 : [**6.7**] Identity Response + RLC ACK (for Identity Request seg 2)
phy -> l2 : [**6.7**] Identity Response CRC (0: Correct)

l2 -> l3 : Identity Response

note over ue, l2
Network continues to send force UL grant to allocate UL resource 
end note
l2 -> ue : [**6.8**] FAPI_HI_PDU (HARQ ACK for Zero Long BSR sent in 6.2)
l2 --> ue : [**6.8**] FAPI_UL_DCI_FORMAT_0 (60 RB)

note over ue, l2
Network sends Attach Reject & RRC Release after Identity Responose received
end note

l3 -> l2 : Attach Reject 
l3 -> l2 : RRC Release

l2 -> phy : [**6.8**] FAPI_DL_DCI_FORMAT_1
l2 -> phy : [**6.8**] FAPI_DLSCH_PDU (for TA command)
l2 -> phy : [**6.9**] FAPI_DL_DCI_FORMAT_1A
l2 -> phy : [**6.9**] FAPI_DLSCH_PDU (for attach reject & rrc release)
l2 -> ue : [**7.0**] MAC Timing Advance Command
l2 -> ue : [**7.1**] Attach Reject + RRC Release (need RLC ACK)

l2 -> phy : [**7.1**] FAPI_ULSCH (for UL DCCH data)
ue -> l2 : [**7.2**] Zero Short BSR + RLC ACK (for Attach Reject & RRC Release)
phy -> l2 : [**7.2**] Zero Short BSR CRC (0: Correct)

note over ue, l2
Network continues to send force UL grant to allocate UL resource 
end note
l2 -> ue : [**7.3**] FAPI_HI_PDU (HARQ ACK for Identity Response sent in 6.7)
l2 --> ue : [**7.3**] FAPI_UL_DCI_FORMAT_0 (60 RB)

note over ue, l2
Network delete ue context
end note

l3 -> l2 : Delete UE Context (PDCP/RLC/MAC/PHY)

l2 -> ue : [**7.3**] Delete Phy UE Context 
ue -> ue : free resource

note over ue
Terminate the connection, 
reset state to idle, prepare
next RACH indication in 
next subframe 1
end note

ue -> l2 : [8.1] RACH, RA-RNTI, preamble

@enduml